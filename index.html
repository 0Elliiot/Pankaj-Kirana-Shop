<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pankaj Kirana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 pb-24">

    <header class="bg-indigo-700 text-white p-4 sticky top-0 shadow-lg flex justify-between items-center z-50">
        <h1 class="text-xl font-bold italic">Pankaj Kirana ðŸ›’</h1>
        <div class="flex gap-2">
            <button onclick="showTrackModal()" class="text-[10px] bg-indigo-500 px-2 py-1 rounded-full">Track</button>
            <button onclick="toggleCart()" class="bg-white text-indigo-700 px-3 py-1 rounded-full font-bold text-sm">
                ðŸ›’ (<span id="cart-count">0</span>)
            </button>
        </div>
    </header>

    <main id="product-list" class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4"></main>

    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex justify-center items-end">
        <div class="bg-white w-full max-w-lg rounded-t-3xl p-6 shadow-2xl">
            <h2 class="text-2xl font-black mb-4">Aapka Order</h2>
            <div id="cart-items" class="space-y-3 mb-6 max-h-48 overflow-y-auto border-b pb-4 text-black font-medium"></div>
            <div class="space-y-3 text-black">
                <input id="cust-name" type="text" placeholder="Apna Naam Likhein" class="w-full p-3 border rounded-xl outline-none focus:border-indigo-500">
                <input id="cust-addr" type="text" placeholder="Ghar ka Address" class="w-full p-3 border rounded-xl outline-none focus:border-indigo-500">
                <div class="flex justify-between items-center py-2 text-xl font-bold">
                    <span>Total:</span><span class="text-green-600">â‚¹<span id="cart-total">0</span></span>
                </div>
                <button id="orderBtn" onclick="placeOrder()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform">
                    âœ… Confirm & Send WhatsApp
                </button>
                <button onclick="toggleCart()" class="w-full mt-2 text-gray-500">Band Karein</button>
            </div>
        </div>
    </div>

    <div id="track-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex justify-center items-center p-4 text-black">
        <div class="bg-white w-full max-w-md rounded-2xl p-6">
            <h2 class="text-xl font-bold mb-4">Order Track Karein</h2>
            <input id="track-id-input" type="text" placeholder="Order ID (e.g. ORD1001)" class="w-full p-3 border rounded-xl mb-4 uppercase">
            <button onclick="trackOrder()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Status Dekhein</button>
            <div id="track-result" class="mt-4 p-4 bg-indigo-50 rounded-xl hidden">
                <p class="font-bold">Status: <span id="status-text" class="text-indigo-700">---</span></p>
                <p class="text-sm mt-1" id="status-msg"></p>
            </div>
            <button onclick="showTrackModal()" class="w-full text-gray-500 mt-4 text-sm underline text-center">Close</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAeG25EZLmrhfedtBwsak0Fd_2Opsa99_g",
            authDomain: "pankaj-kirana-store-38072.firebaseapp.com",
            projectId: "pankaj-kirana-store-38072",
            storageBucket: "pankaj-kirana-store-38072.firebasestorage.app",
            messagingSenderId: "581034855422",
            appId: "1:581034855422:web:aaf2abecef1c0e7ba60eaf"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const myWhatsApp = "91XXXXXXXXXX"; // Apna number yahan 91 ke sath likhein

        const products = [
            { id: 1, name: "Veg Momos", price: 80, img: "ðŸ¥Ÿ" },
            { id: 2, name: "Paneer Momos", price: 120, img: "ðŸ¥Ÿ" },
            { id: 3, name: "Coca Cola", price: 20, img: "ðŸ¥¤" },
            { id: 4, name: "Atta 5kg", price: 245, img: "ðŸŒ¾" }
        ];

        let cart = [];

        function renderProducts() {
            document.getElementById('product-list').innerHTML = products.map(p => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center">
                    <div class="text-4xl mb-2">${p.img}</div>
                    <h3 class="font-bold text-gray-800">${p.name}</h3>
                    <p class="text-indigo-600 font-bold">â‚¹${p.price}</p>
                    <button onclick="addToCart(${p.id})" class="mt-3 w-full bg-indigo-50 text-indigo-700 py-2 rounded-lg font-semibold border border-indigo-100">+ Add</button>
                </div>
            `).join('');
        }

        function addToCart(id) {
            cart.push(products.find(p => p.id === id));
            updateCart();
        }

        function updateCart() {
            document.getElementById('cart-count').innerText = cart.length;
            let total = 0;
            document.getElementById('cart-items').innerHTML = cart.map(item => {
                total += item.price;
                return `<div class="flex justify-between"><span>${item.name}</span><b>â‚¹${item.price}</b></div>`;
            }).join('');
            document.getElementById('cart-total').innerText = total;
        }

        function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); }
        function showTrackModal() { document.getElementById('track-modal').classList.toggle('hidden'); }

        // SEQUENCE ID LOGIC (ORD1001, 1002...)
        function placeOrder() {
            const name = document.getElementById('cust-name').value;
            const addr = document.getElementById('cust-addr').value;
            const total = document.getElementById('cart-total').innerText;

            if(!name || !addr || cart.length === 0) {
                alert("Please saari details bharein!");
                return;
            }

            // Firebase Transaction for Sequence Counter
            const counterRef = db.ref('last_order_id');
            counterRef.transaction((currentValue) => {
                // Agar pehli baar hai toh 1000 se shuru karega
                return (currentValue || 1000) + 1;
            }, (error, committed, snapshot) => {
                if (committed) {
                    const newId = snapshot.val();
                    const orderId = "ORD" + newId;

                    const orderData = {
                        orderId: orderId,
                        name: name,
                        address: addr,
                        items: cart,
                        total: total,
                        status: "Pending",
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Order data save karna
                    db.ref('orders/' + orderId).set(orderData).then(() => {
                        // WhatsApp Message
                        let itemDetails = "";
                        cart.forEach(i => itemDetails += `- ${i.name} (â‚¹${i.price})%0A`);
                        const finalMsg = `*Pankaj Kirana Store*%0A*Naya Order Received!*%0A------------------%0A*Order ID:* ${orderId}%0A*Naam:* ${name}%0A*Address:* ${addr}%0A*Total:* â‚¹${total}%0A%0A*Items:*%0A${itemDetails}%0A------------------%0A*Status:* Pending`;

                        // Redirect to WhatsApp
                        const waLink = "https://api.whatsapp.com/send?phone=" + myWhatsApp + "&text=" + finalMsg;
                        
                        alert("Bhai Order Save Ho Gaya! ID: " + orderId);
                        
                        cart = [];
                        updateCart();
                        toggleCart();
                        
                        window.location.href = waLink;
                    });
                }
            });
        }

        function trackOrder() {
            const id = document.getElementById('track-id-input').value.trim().toUpperCase();
            if(!id) return;
            
            db.ref('orders/' + id).once('value').then((snap) => {
                const data = snap.val();
                const resDiv = document.getElementById('track-result');
                resDiv.classList.remove('hidden');
                if(data) {
                    document.getElementById('status-text').innerText = data.status;
                    let msg = "Order mil gaya hai, Pankaj bhai check kar rahe hain.";
                    if(data.status === "Accepted") msg = "âœ… Order mil gaya! Pankaj bhai ne accept kar liya hai.";
                    if(data.status === "Dispatched") msg = "ðŸšš Aapka order shop se nikal chuka hai!";
                    document.getElementById('status-msg').innerText = msg;
                } else {
                    document.getElementById('status-text').innerText = "Not Found";
                    document.getElementById('status-msg').innerText = "Ghalat ID hai bhai!";
                }
            });
        }
        renderProducts();
    </script>
</body>
</html>
